{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/loader.css">

    <!-- Icons -->
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.3.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

    <title> Xplora </title>
</head>

<body>

    <!-- Navbar -->
    <div class="navbar-box">
        <div class="navbar-box-layer">

            <div class="nav-option-box">
                <h2><a href="/"> Xplora </a></h2>
            </div>

            <div class="nav-account-option-box">
                <div class="nav-account-img">

                </div>
            </div>

        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-box">
        <div class="sidebar-box-layer">

            <div class="sidebar-openBtn">
                <i class="fi fi-rr-menu-burger"></i>
            </div>

            <div class="sidebar-options-box">
                <ul>
                    <li>
                        <button class="new-fileBtn"><i class="fi fi-rr-plus"></i></button>
                        <div class="tooltip">New chat</div>
                    </li>
                    <li>
                        <button class="new-fileBtn"><i class="fi fi-rr-time-past"></i></button>
                        <div class="tooltip">Chat history</div>
                    </li>
                </ul>
            </div>

            <div class="sidebar-footer-box">
                <ul>
                    <li>
                        <button class="new-fileBtn"><i class="fi fi-rr-interrogation"></i></button>
                        <div class="tooltip sidebar-footer-tip">FAQ</div>
                    </li>
                    <li>
                        <button class="new-fileBtn"><i class="fi fi-rr-settings"></i></button>
                        <div class="tooltip sidebar-footer-tip">Settings</div>
                    </li>
                </ul>
            </div>

        </div>
    </div>

    <!-- Main -->
    <div class="main-box">
        <div class="main-box-layer">

            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}

                <div class="chat-box">

                    <div id="feedbackContainer">
                        {% if answer %}
                        <h2>Feedback:</h2>
                        <p>{{ answer }}</p>
                        {% endif %}
                    </div>

                    <div class="chat-box-layer" id="chatLayer">
                        <label for="document">
                            <div class="chat-title">
                                <!-- <h2> Chat with document </h2> -->
                                <!-- Span element to display file names -->
                                <span id="fileNames"></span>
                            </div>

                            <div class="file-upload-box" id="fileUploadBox">
                                <div class="upload-file-icon">
                                    <i class="fi fi-rr-folder-upload"></i>
                                </div>

                                <div class="upload-text">
                                    <h4> Click to upload or drag your file here </h4>
                                    <p> Upload up to 2 files at once, Upgrade for more </p>
                                </div>
                            </div>
                        </label>
                    </div>

                </div>

                <div class="prompt-box">

                    <div class="prompt-box-layer">

                        <div class="prompt-input">
                            <input type="text" name="prompt" placeholder="Enter a prompt here" autocomplete="off">
                        </div>

                        <div class="prompt-action-box">
                            <ul>
                                <li>
                                    <input type="file" name="document" id="document">

                                    <label for="document">
                                        <span class="new-fileBtn"><i class="fi fi-rr-file-upload"></i></span>
                                        <div class="tooltip prompt-upload-tip">Upload file</div>
                                    </label>
                                </li>
                                <li>
                                    <button class="new-fileBtn" id="submitBtn">
                                        <div class="loaderIcons">
                                            <i class="fi fi-rr-paper-plane submit-icon"></i>
                                        </div>
                                        <span class="loader"></span>
                                    </button>
                                    <div class="tooltip prompt-tip">Submit</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="info-text">
                        <p>Xplora may display inaccurate info, so verify its responses. <a href="#"> Your privacy &
                                Xplora
                                Apps </a></p>
                    </div>
                </div>
            </form>

        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'css/app.js' %}"></script>
    <script>
        document.getElementById("uploadForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent default form submission

            var formData = new FormData(this); // Get form data
            var submitBtn = document.getElementById("submitBtn");
            submitBtn.disabled = true; // Disable submit button while processing

            var loader = document.querySelector('.loader');
            var submitIcon = document.querySelector('.loaderIcons');
            const chatLayer = document.getElementById('chatLayer');

            submitIcon.style.display = 'none';
            loader.style.display = 'block';

            fetch("/uploaddocx_view/", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
                .then(response => response.json()) // Parse response as JSON
                .then(data => {
                    submitIcon.style.display = 'block';
                    loader.style.display = 'none';
                    chatLayer.style.display = 'none';
                    // Update feedbackContainer with AI response
                    document.getElementById("feedbackContainer").innerHTML = "<p>" + data.answer + "</p>";
                })
                .catch(error => {
                    console.error("Error:", error);
                    submitIcon.style.display = 'block';
                    loader.style.display = 'none';
                })
                .finally(() => {
                    submitBtn.disabled = false; // Re-enable submit button
                });
        });

    </script>
    <script>
        // Get the file upload box element
        const fileUploadBox = document.getElementById('fileUploadBox');
        const fileInput = document.getElementById('document');
        const fileNamesSpan = document.getElementById('fileNames');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadBox.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight the file upload box when a file is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadBox.addEventListener(eventName, highlight, false);
        });

        // Remove highlighting when the file is dragged out of the file upload box
        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadBox.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        fileUploadBox.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            fileUploadBox.classList.add('highlight');
        }

        function unhighlight() {
            fileUploadBox.classList.remove('highlight');
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            // Display the file names
            let fileNames = '';
            for (const file of files) {
                fileNames += file.name + ', ';
            }
            // Remove trailing comma and space
            fileNames = fileNames.slice(0, -2);
            fileNamesSpan.textContent = 'Files: ' + fileNames;

            // If you want to append the files to the input element, uncomment the following line
            fileInput.files = files;
        }
    </script>

</body>

</html>